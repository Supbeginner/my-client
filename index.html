<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#007bff" />
  <link rel="manifest" href="manifest.json">
  <title>Virtual Client Timer</title>
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    .box {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    label, select, input {
      display: block;
      width: 100%;
      margin-bottom: 1rem;
    }
    button {
      width: 100%;
      padding: 0.75rem;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    #messages {
      margin-top: 2rem;
      background: #ffffff;
      padding: 1rem;
      border-radius: 10px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .msg {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      line-height: 1.5;
      position: relative;
      font-size: 0.95rem;
      white-space: pre-wrap;
    }
    .user {
      background-color: #d1e7dd;
      align-self: flex-end;
      border-top-left-radius: 12px;
      border-bottom-right-radius: 2px;
    }
    .client {
      background-color: #e1ecf9;
      align-self: flex-start;
      border-top-right-radius: 12px;
      border-bottom-left-radius: 2px;
    }
    .msg-header {
      font-size: 0.75rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .msg-time {
      font-size: 0.7rem;
      text-align: right;
      margin-top: 0.3rem;
      opacity: 0.6;
    }
    .profile-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #ccc;
      display: inline-block;
    }
    #userInputArea {
      display: flex;
      margin-top: 1rem;
    }
    #userMsg {
      flex: 1;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    #userInputArea button {
      width: auto;
      padding: 0.75rem 1.25rem;
    }
  </style>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Service Worker ë“±ë¡
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
          .then(() => console.log('Service Worker ë“±ë¡ ì„±ê³µ'))
          .catch(e => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨', e));
      }

      // í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ë²„íŠ¼ í´ë¦­ ì‹œ ê¶Œí•œ í™•ì¸ + ì•Œë¦¼ ì „ì†¡
      const testBtn = document.getElementById('testNotifyBtn');
      if (testBtn) {
        testBtn.addEventListener('click', async () => {
          if (Notification.permission === 'default') {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
              triggerClientNotification('ğŸ“© í´ë¼ì´ì–¸íŠ¸ ë©”ì‹œì§€ ë„ì°©', 'ì§€ê¸ˆ ì–´ë””ê¹Œì§€ í•˜ì…¨ë‚˜ìš”?');
            }
          } else if (Notification.permission === 'granted') {
            triggerClientNotification('ğŸ“© í´ë¼ì´ì–¸íŠ¸ ë©”ì‹œì§€ ë„ì°©', 'ì§€ê¸ˆ ì–´ë””ê¹Œì§€ í•˜ì…¨ë‚˜ìš”?');
          } else {
            alert("ì•Œë¦¼ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”.");
          }
        });
      }
    });

    // ì•Œë¦¼ ë° ì§„ë™ íŠ¸ë¦¬ê±° í•¨ìˆ˜
    function triggerClientNotification(title, body) {
      if ('serviceWorker' in navigator && Notification.permission === 'granted') {
        navigator.serviceWorker.ready.then(registration => {
          console.log("ğŸ“¤ ì•Œë¦¼ ì „ì†¡ ì¤‘...");
          registration.showNotification(title, {
            body: body
          });

          if (navigator.vibrate) {
            console.log("ğŸ“³ ì§„ë™ ì‹¤í–‰ë¨");
            navigator.vibrate([300, 100, 300]);
          }
        });
      } else {
        console.warn("ì•Œë¦¼ ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ServiceWorker ë¯¸ë“±ë¡");
      }
    }
  </script>
  </head>

<body>
  <div class="box">
    <h1>ğŸ•’ ê°€ìƒ í´ë¼ì´ì–¸íŠ¸ íƒ€ì´ë¨¸</h1>
    <label>í´ë¼ì´ì–¸íŠ¸ ì´ë¦„</label>
    <input id="clientName" type="text" placeholder="ì˜ˆ: ê¹€ë¶€ì¥, ìœ¤ë””ìì´ë„ˆ" oninput="clientNameGlobal=this.value" />

    <label>í´ë¼ì´ì–¸íŠ¸ ì„±ê²© ì„ íƒ</label>
    <select id="clientType" onchange="clientStyle=this.value">
      <option value="nice">ì¹œì ˆí•œ ê³ ê°</option>
      <option value="strict">ê¹ê¹í•œ ê³ ê°</option>
      <option value="fun">ìœ ì¾Œí•œ ê³ ê°</option>
    </select>

    <label>ëª©í‘œ ê¸°ê°„ (ì˜ˆ: 3ì¼)</label>
    <input id="goalDuration" type="text" placeholder="ì˜ˆ: 3ì¼" />

    <label>ëª©í‘œ ì‹œê°„</label>
    <div style="display: flex; gap: 1rem;">
      <select id="goalHour">
        <option value="1">1ì‹œ</option>
        <option value="2">2ì‹œ</option>
        <option value="3">3ì‹œ</option>
        <option value="4">4ì‹œ</option>
        <option value="5">5ì‹œ</option>
        <option value="6">6ì‹œ</option>
        <option value="7">7ì‹œ</option>
        <option value="8">8ì‹œ</option>
        <option value="9">9ì‹œ</option>
        <option value="10">10ì‹œ</option>
        <option value="11">11ì‹œ</option>
        <option value="12">12ì‹œ</option>
      </select>
      <select id="goalMinute">
        <option value="0">00ë¶„</option>
        <option value="5">05ë¶„</option>
        <option value="10">10ë¶„</option>
        <option value="15">15ë¶„</option>
        <option value="20">20ë¶„</option>
        <option value="25">25ë¶„</option>
        <option value="30">30ë¶„</option>
        <option value="35">35ë¶„</option>
        <option value="40">40ë¶„</option>
        <option value="45">45ë¶„</option>
        <option value="50">50ë¶„</option>
        <option value="55">55ë¶„</option>
      </select>
      <select id="goalMeridiem">
        <option value="AM">ì˜¤ì „</option>
        <option value="PM">ì˜¤í›„</option>
      </select>
    </div>

    <label>ì••ë°• ë¬¸ì íšŸìˆ˜</label>
    <input id="pressureCount" type="number" min="1" max="20" value="3" />

    <button onclick="startPressureSequence()">ì‘ì—… ì‹œì‘í•˜ê¸°</button>

    <div id="messages"></div>

    <div id="userInputArea">
      <input id="userMsg" type="text" placeholder="ë‹µì¥ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="if(event.key==='Enter'){ sendUserReply(); }" />
      <button onclick="sendUserReply()">ë³´ë‚´ê¸°</button>
    </div>

    <button id="testNotifyBtn">ğŸ”” í…ŒìŠ¤íŠ¸ ì•Œë¦¼</button>
  </div>
<script>
// ë³€ìˆ˜ ì´ˆê¸°í™”
let clientNameGlobal = '';
let clientStyle = 'nice';
let messagesBox = document.getElementById('messages');
let userMsgInput = document.getElementById('userMsg');

// ë©”ì‹œì§€ í‘œì‹œ
function showMessage(name, msg, isUser = false) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (isUser ? 'user' : 'client');

  const header = document.createElement('div');
  header.className = 'msg-header';
  if (!isUser) {
    const icon = document.createElement('span');
    icon.className = 'profile-icon';
    header.appendChild(icon);
  }
  const nameSpan = document.createElement('span');
  nameSpan.textContent = name;
  header.appendChild(nameSpan);

  const content = document.createElement('div');
  content.textContent = msg;

  const time = document.createElement('div');
  time.className = 'msg-time';
  time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  wrapper.appendChild(header);
  wrapper.appendChild(content);
  wrapper.appendChild(time);
  messagesBox.appendChild(wrapper);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// ì‚¬ìš©ì ë©”ì‹œì§€ ë³´ë‚´ê¸°
async function sendUserReply() {
  const msg = userMsgInput.value;
  if (!msg) return;
  showMessage('ë‚˜', msg, true);
  userMsgInput.value = '';
  userMsgInput.blur();

  const reply = await fetchClientReply(msg, clientStyle);
  setTimeout(() => {
    showMessage(clientNameGlobal, reply);
  }, 1200);
}

// ê¸°ë³¸ ë‹µë³€ ë¡œì§
async function fetchClientReply(userMsg, personality) {
  const responses = {
    nice: ["ë„µ! ì²œì²œíˆ í•˜ì…”ë„ ê´œì°®ì•„ìš” ğŸ˜Š", "ê¸°ë‹¤ë¦¬ê³  ìˆì„ê²Œìš”!", "ì–¸ì œë“  í¸í•  ë•Œ ì™„ë£Œí•´ ì£¼ì„¸ìš”~"],
    strict: ["ì§„í–‰ ìƒí™© ë³´ê³  ë°”ëë‹ˆë‹¤.", "ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. ë¹¨ë¦¬ ì²˜ë¦¬í•˜ì„¸ìš”.", "ì§€ì—°ì€ ìš©ë‚©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."],
    fun: ["ì•¼~ ì•„ì§ë„ ì•ˆ í–ˆì–´? ğŸ™„", "ì´ëŸ¬ë‹¤ í˜¼ë‚œë‹¤~ã…‹ã…‹", "ë ˆì¸  ê³ ê³ !! íŒŒì´íŒ…! ğŸ’ª"]
  };
  const group = responses[personality] || responses.strict;
  return group[Math.floor(Math.random() * group.length)];
}

// ì••ë°• ì‹œì‘
let pressureStarted = false;
function startPressureSequence() {
  if (pressureStarted) return;
  pressureStarted = true;

  const pressureCount = parseInt(document.getElementById('pressureCount').value);
  const hour = parseInt(document.getElementById('goalHour').value);
  const minute = parseInt(document.getElementById('goalMinute').value);
  const meridiem = document.getElementById('goalMeridiem').value;
  if (!pressureCount || isNaN(hour) || isNaN(minute) || !meridiem) return;

  const now = new Date();
  const goalTime = new Date();
  let h = hour;
  if (meridiem === 'PM' && h < 12) h += 12;
  if (meridiem === 'AM' && h === 12) h = 0;
  goalTime.setHours(h, minute, 0);

  const diff = goalTime.getTime() - now.getTime();
  if (diff <= 0) return;

  clientNameGlobal = document.getElementById('clientName').value;
  clientStyle = document.getElementById('clientType').value;

  const greetingTemplates = [
    "ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í˜ë‚´ë³´ì‹œì£ !",
    "ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ì¼ì • ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
    "ì˜¤ëŠ˜ ì‘ì—… ìˆœì¡°ë¡­ê²Œ ì‹œì‘í•˜ì…¨ê¸¸ ë°”ëë‹ˆë‹¤."
  ];
  const greetingMsg = greetingTemplates[Math.floor(Math.random() * greetingTemplates.length)];
  showMessage(clientNameGlobal, greetingMsg);
  triggerClientNotification('ğŸ“© í´ë¼ì´ì–¸íŠ¸ ë©”ì‹œì§€ ë„ì°©', `${clientNameGlobal}: ${greetingMsg}`); // âœ… ì•Œë¦¼ ì¶”ê°€
  
  const pressureTemplates = [
    "ì§€ê¸ˆ ì–´ëŠ ì •ë„ ì§„í–‰ëì„ê¹Œìš”?",
    "ì‘ì—… ë§ˆë¬´ë¦¬ ì¤‘ì´ì‹ ê°€ìš”?",
    "ì‹œê°„ì´ ì–¼ë§ˆ ì•ˆ ë‚¨ì•˜ì–´ìš”, ì–´ë–»ê²Œ ë˜ì–´ê°€ë‚˜ìš”?",
    "ì§„í–‰ ìƒí™© ê³µìœ  ë¶€íƒë“œë¦½ë‹ˆë‹¤!",
    "í˜¹ì‹œ ì•„ì§ ì‹œì‘ ì•ˆ í•˜ì‹  ê±´ ì•„ë‹ˆì£ ?"
  ];

  const baseInterval = Math.floor(diff / (pressureCount + 1));
  const intervalTimes = [];
  for (let i = 1; i <= pressureCount; i++) {
    const base = baseInterval * i;
    const offset = Math.floor(Math.random() * (baseInterval / 2));
    intervalTimes.push(base + offset);
  }

  intervalTimes.forEach((delay) => {
    setTimeout(() => {
      const randomMsg = pressureTemplates[Math.floor(Math.random() * pressureTemplates.length)];
      showMessage(clientNameGlobal, randomMsg);
      triggerClientNotification(`âš ï¸ ì§„í–‰ ìƒí™© ì ê²€`, `${clientNameGlobal}: ${randomMsg}`); // âœ… ì•Œë¦¼ ì¶”ê°€
    }, delay);
  });

  setTimeout(() => {
    const finalMsg = "ğŸ›‘ ì§€ê¸ˆì´ ë§ˆê° ì‹œê°„ì…ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ ì œì¶œ ë¶€íƒë“œë¦½ë‹ˆë‹¤!";
    triggerClientNotification(`â° ë§ˆê° ì•Œë¦¼`, `${clientNameGlobal}: ${finalMsg}`); // âœ… ì•Œë¦¼ ì¶”ê°€
  }, diff);
}
</script>
</body>
</html>
