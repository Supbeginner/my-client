<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Virtual Client Timer</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://cdn.jsdelivr.net/gh/moonspam/NanumSquare@1.0/nanumsquare.css" rel="stylesheet">
  <style>
    body {
      font-family: 'NanumSquare', sans-serif;
      background-color: #f3f4f6;
      color: #333;
      padding: 2rem;
      max-width: 700px;
      margin: auto;
    }

    h1 {
      text-align: center;
      font-weight: 700;
      font-size: 1.8rem;
      color: #444;
      margin-bottom: 2rem;
    }

    .box {
      background: #ffffff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      border: 1px solid #e2e8f0;
    }

    label {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 0.5rem;
      display: block;
      margin-top: 1.5rem;
    }

    input, select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background-color: #f9fafb;
      font-size: 0.95rem;
      transition: 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #a5b4fc;
      background-color: #fff;
    }

    button {
      margin-top: 2rem;
      width: 100%;
      padding: 0.9rem 1.25rem;
      border: none;
      border-radius: 10px;
      background-color: #a5b4fc;
      color: #fff;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #818cf8;
    }

    #messages {
      margin-top: 2rem;
      background: #f9fafb;
      padding: 1rem;
      border-radius: 12px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .msg {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 14px;
      line-height: 1.5;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }

    .user {
      background-color: #e0f2fe;
      align-self: flex-end;
      border-top-left-radius: 14px;
      border-bottom-right-radius: 4px;
    }

    .client {
      background-color: #ede9fe;
      align-self: flex-start;
      border-top-right-radius: 14px;
      border-bottom-left-radius: 4px;
    }

    .msg-time {
      font-size: 0.75rem;
      text-align: right;
      margin-top: 0.25rem;
      color: #999;
    }

    #userInputArea {
      display: flex;
      margin-top: 1rem;
      gap: 0.5rem;
    }

    #userMsg {
      flex: 1;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background-color: #f9fafb;
    }

    #userInputArea button {
      width: auto;
      padding: 0.75rem 1.25rem;
    }

    select:not(:last-child) {
      margin-bottom: 0.5rem;
    }

    .time-selects {
      display: flex;
      gap: 0.75rem;
    }

    #testNotifyBtn {
      background: #cbd5e1;
      color: #333;
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <div class="box">
    <h1>🕒 가상 클라이언트 타이머</h1>

    <label>클라이언트 이름</label>
    <input id="clientName" type="text" placeholder="예: 김부장, 윤디자이너" oninput="clientNameGlobal=this.value" />

    <label>클라이언트 성격 선택</label>
    <select id="clientType" onchange="clientStyle=this.value">
      <option value="nice">친절한 고객</option>
      <option value="strict">깐깐한 고객</option>
      <option value="fun">유쾌한 고객</option>
    </select>

    <label>목표 기간 (예: 3일)</label>
    <input id="goalDuration" type="text" placeholder="예: 3일" />

    <label>목표 시간</label>
    <div class="time-selects">
      <select id="goalHour">
        <option value="1">1시</option>
        <option value="2">2시</option>
        <option value="3">3시</option>
        <option value="4">4시</option>
        <option value="5">5시</option>
        <option value="6">6시</option>
        <option value="7">7시</option>
        <option value="8">8시</option>
        <option value="9">9시</option>
        <option value="10">10시</option>
        <option value="11">11시</option>
        <option value="12">12시</option>
      </select>
      <select id="goalMinute">
        <option value="0">00분</option>
        <option value="5">05분</option>
        <option value="10">10분</option>
        <option value="15">15분</option>
        <option value="20">20분</option>
        <option value="25">25분</option>
        <option value="30">30분</option>
        <option value="35">35분</option>
        <option value="40">40분</option>
        <option value="45">45분</option>
        <option value="50">50분</option>
        <option value="55">55분</option>
      </select>
      <select id="goalMeridiem">
        <option value="AM">오전</option>
        <option value="PM">오후</option>
      </select>
    </div>

    <label>압박 문자 횟수</label>
    <input id="pressureCount" type="number" min="1" max="20" value="3" />

    <button onclick="startPressureSequence()">작업 시작하기</button>

    <div id="messages"></div>

    <div id="userInputArea">
      <input id="userMsg" type="text" placeholder="답장을 입력하세요..." onkeyup="if(event.key==='Enter'){ sendUserReply(); }" />
      <button onclick="sendUserReply()">보내기</button>
    </div>

    <button id="testNotifyBtn">🔔 테스트 알림</button>
  </div>
<script>
// 변수 초기화
let clientNameGlobal = '';
let clientStyle = 'nice';
let messagesBox = document.getElementById('messages');
let userMsgInput = document.getElementById('userMsg');

// 메시지 표시
function showMessage(name, msg, isUser = false) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (isUser ? 'user' : 'client');

  const header = document.createElement('div');
  header.className = 'msg-header';
  if (!isUser) {
    const icon = document.createElement('span');
    icon.className = 'profile-icon';
    header.appendChild(icon);
  }
  const nameSpan = document.createElement('span');
  nameSpan.textContent = name;
  header.appendChild(nameSpan);

  const content = document.createElement('div');
  content.textContent = msg;

  const time = document.createElement('div');
  time.className = 'msg-time';
  time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  wrapper.appendChild(header);
  wrapper.appendChild(content);
  wrapper.appendChild(time);
  messagesBox.appendChild(wrapper);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// 사용자 메시지 보내기
async function sendUserReply() {
  const msg = userMsgInput.value;
  if (!msg) return;
  showMessage('나', msg, true);
  userMsgInput.value = '';
  userMsgInput.blur();

  const reply = await fetchClientReply(msg, clientStyle);
  setTimeout(() => {
    showMessage(clientNameGlobal, reply);
  }, 1200);
    // ✅ 클라이언트 응답에 대한 알림 추가
    triggerClientNotification("📩 클라이언트 답장", `${clientNameGlobal}: ${reply}`);
}

// 기본 답변 로직
async function fetchClientReply(userMsg, personality) {
  const responses = {
    nice: ["넵! 천천히 하셔도 괜찮아요 😊", "기다리고 있을게요!", "언제든 편할 때 완료해 주세요~"],
    strict: ["진행 상황 보고 바랍니다.", "시간이 없습니다. 빨리 처리하세요.", "지연은 용납되지 않습니다."],
    fun: ["야~ 아직도 안 했어? 🙄", "이러다 혼난다~ㅋㅋ", "레츠 고고!! 파이팅! 💪"]
  };
  const group = responses[personality] || responses.strict;
  return group[Math.floor(Math.random() * group.length)];
}

// 압박 시작
let pressureStarted = false;
function startPressureSequence() {
  if (pressureStarted) return;
  pressureStarted = true;

  const pressureCount = parseInt(document.getElementById('pressureCount').value);
  const hour = parseInt(document.getElementById('goalHour').value);
  const minute = parseInt(document.getElementById('goalMinute').value);
  const meridiem = document.getElementById('goalMeridiem').value;
  if (!pressureCount || isNaN(hour) || isNaN(minute) || !meridiem) return;

  const now = new Date();
  const goalTime = new Date();
  let h = hour;
  if (meridiem === 'PM' && h < 12) h += 12;
  if (meridiem === 'AM' && h === 12) h = 0;
  goalTime.setHours(h, minute, 0);

  const diff = goalTime.getTime() - now.getTime();
  if (diff <= 0) return;

  clientNameGlobal = document.getElementById('clientName').value;
  clientStyle = document.getElementById('clientType').value;

  const greetingTemplates = [
    "좋은 아침입니다. 오늘도 힘내보시죠!",
    "안녕하세요! 오늘 일정 잘 부탁드립니다.",
    "오늘 작업 순조롭게 시작하셨길 바랍니다."
  ];
  const greetingMsg = greetingTemplates[Math.floor(Math.random() * greetingTemplates.length)];
  showMessage(clientNameGlobal, greetingMsg);
  triggerClientNotification('📩 클라이언트 메시지 도착', `${clientNameGlobal}: ${greetingMsg}`); // ✅ 알림 추가
  
  const pressureTemplates = [
    "지금 어느 정도 진행됐을까요?",
    "작업 마무리 중이신가요?",
    "시간이 얼마 안 남았어요, 어떻게 되어가나요?",
    "진행 상황 공유 부탁드립니다!",
    "혹시 아직 시작 안 하신 건 아니죠?"
  ];

  const baseInterval = Math.floor(diff / (pressureCount + 1));
  const intervalTimes = [];
  for (let i = 1; i <= pressureCount; i++) {
    const base = baseInterval * i;
    const offset = Math.floor(Math.random() * (baseInterval / 2));
    intervalTimes.push(base + offset);
  }

  intervalTimes.forEach((delay) => {
    setTimeout(() => {
      const randomMsg = pressureTemplates[Math.floor(Math.random() * pressureTemplates.length)];
      showMessage(clientNameGlobal, randomMsg);
      triggerClientNotification(`⚠️ 진행 상황 점검`, `${clientNameGlobal}: ${randomMsg}`); // ✅ 알림 추가
    }, delay);
  });

  setTimeout(() => {
    const finalMsg = "🛑 지금이 마감 시간입니다. 최종 결과 제출 부탁드립니다!";
    triggerClientNotification(`⏰ 마감 알림`, `${clientNameGlobal}: ${finalMsg}`); // ✅ 알림 추가
  }, diff);
}
</script>

  <button id="showTokenBtn">🔑 내 토큰 확인</button>
  <p id="fcmToken">FCM 토큰이 여기에 표시됩니다.</p>

<script>
  // 진동 및 알림 트리거 함수
  window.triggerClientNotification = function(title, body) {
    if ('serviceWorker' in navigator && Notification.permission === 'granted') {
      navigator.serviceWorker.ready.then((registration) => {
        console.log("📤 알림 전송 중...");
        registration.showNotification(title, {
          body: body,
          vibrate: [200, 100, 200],
          data: {
            url: "https://supbeginner.github.io/my-client/" // 알림 클릭 시 이동할 URL
        }
        });

        if (navigator.vibrate) {
          console.log("📳 진동 실행됨");
          navigator.vibrate([300, 100, 300]);
        }
      });
    } else {
      console.warn("알림 권한 없음 또는 ServiceWorker 미등록");
    }
  };
</script>
  
<script type="module">
  // Firebase SDK import (버전은 사용 중인 firebasejs와 일치하게 설정하세요)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCAcf-a30FlrgcYd3cgiXZ3c3zIMG6ThiI",
    authDomain: "my-client-75392.firebaseapp.com",
    projectId: "my-client-75392",
    storageBucket: "my-client-75392.firebasestorage.app",
    messagingSenderId: "324589088923",
    appId: "1:324589088923:web:6a2b7e645ab2129844563e"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  // Service Worker 등록 및 토큰 요청
  navigator.serviceWorker.register('./firebase-messaging-sw.js')
    .then((registration) => {
      console.log("✅ Service Worker 등록 성공");

      return Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          return getToken(messaging, {
            vapidKey: "BHuYHY7nFMDzV_2RL3sGv0KIy_S5vFsDLdlMhkcB7IHql74Cjhwul6moNDWvNyx5FEXWD8Zo3DSftkNdBISJxC4",
            serviceWorkerRegistration: registration
          });
        } else {
          throw new Error("❌ 알림 권한이 거부됨");
        }
      });
    })
    .then((token) => {
      console.log("📲 받은 FCM 토큰:", token);
      // 필요시 서버에 저장 가능
    })
    .catch((err) => {
      console.error("❌ FCM 초기화 실패:", err);
    });

  // 토큰을 수동으로 확인할 수 있도록 전역 함수 등록
  window.checkToken = async () => {
    try {
      const registration = await navigator.serviceWorker.ready;
      const token = await getToken(messaging, {
        vapidKey: "BHuYHY7nFMDzV_2RL3sGv0KIy_S5vFsDLdlMhkcB7IHql74Cjhwul6moNDWvNyx5FEXWD8Zo3DSftkNdBISJxC4",
        serviceWorkerRegistration: registration
      });
      console.log("📲 수동으로 확인한 토큰:", token);
    } catch (err) {
      console.error("❌ 토큰 확인 실패:", err);
    }
  };

    // 알림 수신 핸들러
  onMessage(messaging, (payload) => {
    console.log("📩 메시지 도착:", payload);
    triggerClientNotification("📬 FCM 알림 도착", payload.notification.body);
  });
  
</script>

<script>
  
  // 테스트 버튼 클릭 시 알림 트리거
  document.addEventListener('DOMContentLoaded', () => {
    const testBtn = document.getElementById('testNotifyBtn');
    if (testBtn) {
      testBtn.addEventListener('click', () => {
        triggerClientNotification("📩 테스트 알림", "지금 어디까지 하셨나요?");
      });
    }

      // ✅ FCM 토큰 보기 버튼 이벤트
    const showTokenBtn = document.getElementById('showTokenBtn');
    if (showTokenBtn) {
      showTokenBtn.addEventListener('click', async () => {
        const token = await getToken(messaging, {
          vapidKey: "BHuYHY7nFMDzV_2RL3sGv0KIy_S5vFsDLdlMhkcB7IHql74Cjhwul6moNDWvNyx5FEXWD8Zo3DSftkNdBISJxC4",
          serviceWorkerRegistration: await navigator.serviceWorker.ready
        });
        document.getElementById('fcmToken').innerText = token;
      });
    }
  });
</script>
</body>
</html>
