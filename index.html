<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Client</title>
  <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.1/NanumSquareRound.css" rel="stylesheet" />
  <!-- flatpickr ìŠ¤íƒ€ì¼ê³¼ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <style>
    :root {
      --bg-color: #f3f4f6;
      --box-bg: #ffffff;
      --text-color: #333;
      --border-color: #e2e8f0;
      --input-bg: #f9fafb;
      --primary: #a5b4fc;
      --primary-hover: #818cf8;
      --accent: #cbd5e1;
      --client-msg: #ede9fe;
      --user-msg: #e0f2fe;
    }

    body.dark {
      --bg-color: #1e1e1e;
      --box-bg: #2c2c2e;
      --text-color: #f5f5f5;
      --border-color: #3c3c3e;
      --input-bg: #3a3a3c;
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --accent: #4b5563;
      --client-msg: #4f46e5;
      --user-msg: #2563eb;
    }

    * {
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    body {
      font-family: 'NanumSquareRound', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 2rem;
      max-width: 700px;
      margin: auto;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .dark-toggle {
      background: var(--accent);
      color: var(--text-color);
      border: none;
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    h1 {
      text-align: center;
      font-weight: 800;
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .box {
      background: var(--box-bg);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
      border: 1px solid var(--border-color);
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

  input, select, textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--input-bg);
    box-sizing: border-box;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    background-color: #fff;
  }

    .time-selects {
      display: flex;
      gap: 1rem;
    }

    .time-selects select {
      flex: 1;
    }

    button {
      margin-top: 2rem;
      width: 100%;
      padding: 0.9rem 1.25rem;
      border: none;
      border-radius: 10px;
      background-color: var(--primary);
      color: white;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    #userInputArea {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    #userInputArea input {
      flex: 1;
    }

    #userInputArea button {
      white-space: nowrap;
      padding: 0.75rem 1rem;
      width: auto;
      margin-top: 0; /* âœ… ë²„íŠ¼ì´ ì•„ë˜ë¡œ ë°€ë¦¬ì§€ ì•Šë„ë¡ */
    }

    #messages {
      margin-top: 2rem;
      background: var(--input-bg);
      padding: 1rem;
      border-radius: 12px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      white-space: pre-wrap;
    }

    .msg {
      max-width: 80%;
      padding: 0.75rem 1rem;
      border-radius: 14px;
      font-size: 0.9rem;
      animation: fadeIn 0.4s ease forwards;
    }

    .user {
      background-color: var(--user-msg);
      align-self: flex-end;
      border-top-left-radius: 14px;
      border-bottom-right-radius: 4px;
    }

    .client {
      background-color: var(--client-msg);
      align-self: flex-start;
      border-top-right-radius: 14px;
      border-bottom-left-radius: 4px;
    }

    .msg-time {
      font-size: 0.75rem;
      text-align: right;
      margin-top: 0.25rem;
      color: #999;
    }

    #userMsg {
      flex: 1;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
    }


    #sendBtn {
      width: auto;
      padding: 0.75rem 1.25rem;
      background-color: var(--primary);
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
    }

    #sendBtn:hover {
      background-color: var(--primary-hover);
    }

    #testNotifyBtn {
      background: var(--accent);
      color: var(--text-color);
      margin-top: 1rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .icon {
      font-size: 1rem;
    }

    .msg-header {
      font-size: 0.75rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .profile-icon {
      width: 18px;
      height: 18px;
      background: #ccc;
      border-radius: 50%;
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <h1>My client</h1>
    <button class="dark-toggle" onclick="toggleDarkMode()">ğŸŒ™</button>
  </div>

  <div class="box">
    <div class="form-group">
      <label><span class="icon">ğŸ§‘â€ğŸ’¼</span> í´ë¼ì´ì–¸íŠ¸ ì´ë¦„</label>
      <input class="form-input" id="clientName" type="text" placeholder="ì˜ˆ: ê¹€ë¶€ì¥, ìœ¤ë””ìì´ë„ˆ" oninput="clientNameGlobal=this.value" />
    </div>
    
    <div class="form-group">
      <label><span class="icon">ğŸ­</span> í´ë¼ì´ì–¸íŠ¸ ì„±ê²© ì„ íƒ</label>
      <select class="form-input" id="clientType" onchange="clientStyle=this.value">
        <option value="nice">ì¹œì ˆí•œ ê³ ê°</option>
        <option value="strict">ê¹ê¹í•œ ê³ ê°</option>
        <option value="fun">ìœ ì¾Œí•œ ê³ ê°</option>
      </select>
    </div>
    
    <div class="form-group">
      <label><span class="icon">ğŸ“…</span> ëª©í‘œ ê¸°ê°„</label>
      <input id="goalDateTime" type="text" placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" />
    </div>

    <div class="form-group">
      <label>ì˜ˆì¹˜ê¸ˆ (ì›)</label>
      <input id="depositInput" type="number" placeholder="ì˜ˆ: 10000" value="10000" />
    </div>

    <div class="form-group">
      <label><span class="icon">ğŸ“…</span> 1ì°¨ ì‹œì•ˆ ì œì¶œ ë§ˆê° ì‹œê°</label>
      <input id="draftDateTime" type="text" placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" />
    </div>

    <div class="form-group">
      <label><span class="icon">ğŸ’¢</span> ì••ë°• ë¬¸ì íšŸìˆ˜</label>
      <input class="form-input" id="pressureCount" type="number" min="1" max="20" value="3" />
    </div>

    <button onclick="startPressureSequence()">ì‘ì—… ì‹œì‘í•˜ê¸°</button>
    <div id="messages"></div>
    <div class="form-group" id="userInputArea" style="margin-top: 1.5rem; display: flex; gap: 0.5rem; align-items: center;">
      <input id="userMsg" type="text" placeholder="ë‹µì¥ì„ ì…ë ¥í•˜ì„¸ìš”..." style="flex: 1;" />
      <button id="sendBtn" onclick="sendUserReply()">ë³´ë‚´ê¸°</button>
    </div>
    <button id="testNotifyBtn">ğŸ”” í…ŒìŠ¤íŠ¸ ì•Œë¦¼</button>
  </div>
  <script>
    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

  </script>
<script>
// ë³€ìˆ˜ ì´ˆê¸°í™”
let clientNameGlobal = '';
let firstDraftDue = false;
let firstDraftSubmitted = false;
let clientStyle = 'nice';
let messagesBox = document.getElementById('messages');
let userMsgInput = document.getElementById('userMsg');

// ë©”ì‹œì§€ í‘œì‹œ
function showMessage(name, msg, isUser = false) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (isUser ? 'user' : 'client');

  const header = document.createElement('div');
  header.className = 'msg-header';
  if (!isUser) {
    const icon = document.createElement('span');
    icon.className = 'profile-icon';
    header.appendChild(icon);
  }
  const nameSpan = document.createElement('span');
  nameSpan.textContent = name;
  header.appendChild(nameSpan);

  const content = document.createElement('div');
  content.textContent = msg;

  const time = document.createElement('div');
  time.className = 'msg-time';
  time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  wrapper.appendChild(header);
  wrapper.appendChild(content);
  wrapper.appendChild(time);
  messagesBox.appendChild(wrapper);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// ì‚¬ìš©ì ë©”ì‹œì§€ ë³´ë‚´ê¸°
async function sendUserReply() {
  const msg = userMsgInput.value;
  if (!msg) return;
  showMessage('ë‚˜', msg, true);
  userMsgInput.value = '';
  userMsgInput.blur();

  // 1ì°¨ ì‹œì•ˆ ì œì¶œì„ ìš”ì²­ë°›ì€ ìƒíƒœì´ë©°, ì•„ì§ ì œì¶œë˜ì§€ ì•Šì•˜ë‹¤ë©´
  if (firstDraftDue && !firstDraftSubmitted) {
    const prev = submittedDrafts[submittedDrafts.length - 1] || "";
    submittedDrafts.push(msg);
    firstDraftSubmitted = true;
    firstDraftDue = false;

    const result = await evaluateDraftProgress(prev, msg);
    if (result === "ì§„ì²™ë„ ì—†ìŒ") {
      deposit -= 1000;
      showMessage(clientNameGlobal, `âš ï¸ ì§„ì²™ë„ê°€ ì—†ìŠµë‹ˆë‹¤. 1,000ì› ì°¨ê°ë©ë‹ˆë‹¤. ë‚¨ì€ ì˜ˆì¹˜ê¸ˆ: ${deposit.toLocaleString()}ì›`);
    } else {
      showMessage(clientNameGlobal, "âœ… ìë£Œ ë°›ì•˜ìŠµë‹ˆë‹¤. ê³„ì† í˜ë‚´ì£¼ì„¸ìš”!");
    }
    return;
  }


  const reply = await fetchClientReply(msg, clientStyle);
  setTimeout(() => {
    showMessage(clientNameGlobal, reply);
  }, 1200);
    // âœ… í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µì— ëŒ€í•œ ì•Œë¦¼ ì¶”ê°€
    triggerClientNotification("ğŸ“© í´ë¼ì´ì–¸íŠ¸ ë‹µì¥", `${clientNameGlobal}: ${reply}`);
}

// ê¸°ë³¸ ë‹µë³€ ë¡œì§
async function fetchClientReply(userMsg, personality) {
  const responses = {
    nice: ["ë„µ! ì²œì²œíˆ í•˜ì…”ë„ ê´œì°®ì•„ìš” ğŸ˜Š", "ê¸°ë‹¤ë¦¬ê³  ìˆì„ê²Œìš”!", "ì–¸ì œë“  í¸í•  ë•Œ ì™„ë£Œí•´ ì£¼ì„¸ìš”~"],
    strict: ["ì§„í–‰ ìƒí™© ë³´ê³  ë°”ëë‹ˆë‹¤.", "ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤. ë¹¨ë¦¬ ì²˜ë¦¬í•˜ì„¸ìš”.", "ì§€ì—°ì€ ìš©ë‚©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."],
    fun: ["ì•¼~ ì•„ì§ë„ ì•ˆ í–ˆì–´? ğŸ™„", "ì´ëŸ¬ë‹¤ í˜¼ë‚œë‹¤~ã…‹ã…‹", "ë ˆì¸  ê³ ê³ !! íŒŒì´íŒ…! ğŸ’ª"]
  };
  const group = responses[personality] || responses.strict;
  return group[Math.floor(Math.random() * group.length)];
}

// ì••ë°• ì‹œì‘
let pressureStarted = false;
function startPressureSequence() {
  if (pressureStarted) return;
  pressureStarted = true;

  const pressureCount = parseInt(document.getElementById('pressureCount').value);
  const goalDate = document.getElementById("goalDateTime").value;
  const goalTime = goalDate ? new Date(goalDate) : null;

  const now = new Date();

  const diff = goalTime.getTime() - now.getTime();
  if (diff <= 0) return;

  clientNameGlobal = document.getElementById('clientName').value;
  clientStyle = document.getElementById('clientType').value;

  const greetingTemplates = [
    "ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ë„ í˜ë‚´ë³´ì‹œì£ !",
    "ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ì¼ì • ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤.",
    "ì˜¤ëŠ˜ ì‘ì—… ìˆœì¡°ë¡­ê²Œ ì‹œì‘í•˜ì…¨ê¸¸ ë°”ëë‹ˆë‹¤."
  ];
  const greetingMsg = greetingTemplates[Math.floor(Math.random() * greetingTemplates.length)];
  showMessage(clientNameGlobal, greetingMsg);
  triggerClientNotification('ğŸ“© í´ë¼ì´ì–¸íŠ¸ ë©”ì‹œì§€ ë„ì°©', `${clientNameGlobal}: ${greetingMsg}`); // âœ… ì•Œë¦¼ ì¶”ê°€
  
  const pressureTemplates = [
    "ì§€ê¸ˆ ì–´ëŠ ì •ë„ ì§„í–‰ëì„ê¹Œìš”?",
    "ì‘ì—… ë§ˆë¬´ë¦¬ ì¤‘ì´ì‹ ê°€ìš”?",
    "ì‹œê°„ì´ ì–¼ë§ˆ ì•ˆ ë‚¨ì•˜ì–´ìš”, ì–´ë–»ê²Œ ë˜ì–´ê°€ë‚˜ìš”?",
    "ì§„í–‰ ìƒí™© ê³µìœ  ë¶€íƒë“œë¦½ë‹ˆë‹¤!",
    "í˜¹ì‹œ ì•„ì§ ì‹œì‘ ì•ˆ í•˜ì‹  ê±´ ì•„ë‹ˆì£ ?"
  ];

  const baseInterval = Math.floor(diff / (pressureCount + 1));
  const intervalTimes = [];
  for (let i = 1; i <= pressureCount; i++) {
    const base = baseInterval * i;
    const offset = Math.floor(Math.random() * (baseInterval / 2));
    intervalTimes.push(base + offset);
  }

  intervalTimes.forEach((delay) => {
    setTimeout(() => {
      const randomMsg = pressureTemplates[Math.floor(Math.random() * pressureTemplates.length)];
      showMessage(clientNameGlobal, randomMsg);
      triggerClientNotification(`âš ï¸ ì§„í–‰ ìƒí™© ì ê²€`, `${clientNameGlobal}: ${randomMsg}`); // âœ… ì•Œë¦¼ ì¶”ê°€
    }, delay);
  });

  setTimeout(() => {
    const finalMsg = "ğŸ›‘ ì§€ê¸ˆì´ ë§ˆê° ì‹œê°„ì…ë‹ˆë‹¤. ìµœì¢… ê²°ê³¼ ì œì¶œ ë¶€íƒë“œë¦½ë‹ˆë‹¤!";
    triggerClientNotification(`â° ë§ˆê° ì•Œë¦¼`, `${clientNameGlobal}: ${finalMsg}`); // âœ… ì•Œë¦¼ ì¶”ê°€
  }, diff);
  scheduleFirstDraftReminder();
}
</script>

<script>
  // ì§„ë™ ë° ì•Œë¦¼ íŠ¸ë¦¬ê±° í•¨ìˆ˜
  window.triggerClientNotification = function(title, body) {
    if ('serviceWorker' in navigator && Notification.permission === 'granted') {
      navigator.serviceWorker.ready.then((registration) => {
        console.log("ğŸ“¤ ì•Œë¦¼ ì „ì†¡ ì¤‘...");
        registration.showNotification(title, {
          body: body,
          vibrate: [200, 100, 200],
          data: {
            url: "https://supbeginner.github.io/my-client/" // ì•Œë¦¼ í´ë¦­ ì‹œ ì´ë™í•  URL
        }
        });

        if (navigator.vibrate) {
          console.log("ğŸ“³ ì§„ë™ ì‹¤í–‰ë¨");
          navigator.vibrate([300, 100, 300]);
        }
      });
    } else {
      console.warn("ì•Œë¦¼ ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ServiceWorker ë¯¸ë“±ë¡");
    }
  };
  function validateDraftDeadline() {
  const goal = new Date(document.getElementById("goalDateTime").value);
  const draft = new Date(document.getElementById("draftDateTime").value);
  if (draft >= goal) {
    alert("1ì°¨ ì‹œì•ˆ ë§ˆê° ê¸°í•œì€ ëª©í‘œ ì‹œê°„ë³´ë‹¤ ì•ì„œì•¼ í•©ë‹ˆë‹¤.");
    return false;
  }
  return true;
}
  function scheduleFirstDraftReminder() {
  const deadline = getDraftDeadline();
  if (!deadline) return;

  const now = new Date();
  const delay = deadline - now;
  if (delay <= 0) return;

  setTimeout(() => {
    showMessage(clientNameGlobal, "ë„ê¹¨ë¹„ì…ë‹ˆë‹¤. 1ì°¨ ì‹œì•ˆ ë¶€íƒë“œë¦¬ê² ìŠµë‹ˆë‹¤.");
    firstDraftDue = true; // ì œì¶œ ì²´í¬ íŠ¸ë¦¬ê±°

    const preCount = submittedDrafts.length;
    setTimeout(() => {
      if (submittedDrafts.length === preCount) {
        showMessage(clientNameGlobal, "ìë£ŒëŠ” ì•„ì§ ë„ì°©í•˜ì§€ ì•Šì•˜êµ°ìš”. 25ë¶„ ë‚´ë¡œ ìë£Œ ì•ˆ ë³´ë‚´ì‹œë©´ 1,000ì› ì°¨ê°í•˜ê² ìŠµë‹ˆë‹¤.");

        setTimeout(() => {
          if (submittedDrafts.length === preCount) {
            if (deposit >= 1000) {
              deposit -= 1000;
              showMessage(clientNameGlobal, `âŒ ì œì¶œ ë¯¸ì´í–‰! 1,000ì› ì°¨ê°. ë‚¨ì€ ì˜ˆì¹˜ê¸ˆ: ${deposit.toLocaleString()}ì›`);
            } else {
              showMessage(clientNameGlobal, "â— ì˜ˆì¹˜ê¸ˆì´ ë¶€ì¡±í•˜ì—¬ ë” ì´ìƒ ì°¨ê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
          } else {
            const prev = submittedDrafts[preCount - 1] || "";
            const latest = submittedDrafts[submittedDrafts.length - 1];
            evaluateDraftProgress(prev, latest).then(result => {
              if (result === "ì§„ì²™ë„ ì—†ìŒ") {
                if (deposit >= 1000) {
                  deposit -= 1000;
                  showMessage(clientNameGlobal, `âš ï¸ ì§„ì²™ë„ê°€ ì—†ìŠµë‹ˆë‹¤. 1,000ì› ì°¨ê°ë©ë‹ˆë‹¤. ë‚¨ì€ ì˜ˆì¹˜ê¸ˆ: ${deposit.toLocaleString()}ì›`);
                } else {
                  showMessage(clientNameGlobal, "â— ì˜ˆì¹˜ê¸ˆì´ ë¶€ì¡±í•˜ì—¬ ë” ì´ìƒ ì°¨ê°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
              } else {
                showMessage(clientNameGlobal, "âœ… ìë£Œ ë°›ì•˜ìŠµë‹ˆë‹¤. ì¡°ê¸ˆ ë” ë¹¨ë¦¬ ì§„í–‰í•´ì£¼ì„¸ìš”.");
              }
            });
          }
        }, 25 * 60 * 1000);
      }
    }, 5 * 60 * 1000);
  }, delay);
}
</script>
<script>
  // flatpickr ë‹¤í¬ëª¨ë“œ ìë™ ëŒ€ì‘ ì˜ˆì‹œ
  let draftDeadlineObj = null;

  function initFlatpickrDarkModeSupport() {
    const isDark = document.body.classList.contains("dark");
    flatpickr("#goalDateTime", {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      minDate: "today",
      time_24hr: false,
      theme: isDark ? "material_dark" : "light"
    });
    flatpickr("#draftDateTime", {
      enableTime: true,
      dateFormat: "Y-m-d H:i",
      minDate: "today",
      time_24hr: false,
      theme: isDark ? "material_dark" : "light"
      onChange: function(selectedDates) {
      draftDeadlineObj = selectedDates[0];  // âœ… ì—¬ê¸°ì„œ ì •í™•í•œ Date ê°ì²´ ì €ì¥
      }
    });
  }
  </script>
  
<script type="module">
  // Firebase SDK import (ë²„ì „ì€ ì‚¬ìš© ì¤‘ì¸ firebasejsì™€ ì¼ì¹˜í•˜ê²Œ ì„¤ì •í•˜ì„¸ìš”)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCAcf-a30FlrgcYd3cgiXZ3c3zIMG6ThiI",
    authDomain: "my-client-75392.firebaseapp.com",
    projectId: "my-client-75392",
    storageBucket: "my-client-75392.firebasestorage.app",
    messagingSenderId: "324589088923",
    appId: "1:324589088923:web:6a2b7e645ab2129844563e"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const messaging = getMessaging(app);

  // Service Worker ë“±ë¡ ë° í† í° ìš”ì²­
  navigator.serviceWorker.register('./firebase-messaging-sw.js')
    .then((registration) => {
      console.log("âœ… Service Worker ë“±ë¡ ì„±ê³µ");

      return Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          return getToken(messaging, {
            vapidKey: "BHuYHY7nFMDzV_2RL3sGv0KIy_S5vFsDLdlMhkcB7IHql74Cjhwul6moNDWvNyx5FEXWD8Zo3DSftkNdBISJxC4",
            serviceWorkerRegistration: registration
          });
        } else {
          throw new Error("âŒ ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë¨");
        }
      });
    })
    .then((token) => {
      console.log("ğŸ“² ë°›ì€ FCM í† í°:", token);
      // í•„ìš”ì‹œ ì„œë²„ì— ì €ì¥ ê°€ëŠ¥
    })
    .catch((err) => {
      console.error("âŒ FCM ì´ˆê¸°í™” ì‹¤íŒ¨:", err);
    });

  // í† í°ì„ ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì „ì—­ í•¨ìˆ˜ ë“±ë¡
  window.checkToken = async () => {
    try {
      const registration = await navigator.serviceWorker.ready;
      const token = await getToken(messaging, {
        vapidKey: "BHuYHY7nFMDzV_2RL3sGv0KIy_S5vFsDLdlMhkcB7IHql74Cjhwul6moNDWvNyx5FEXWD8Zo3DSftkNdBISJxC4",
        serviceWorkerRegistration: registration
      });
      console.log("ğŸ“² ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•œ í† í°:", token);
    } catch (err) {
      console.error("âŒ í† í° í™•ì¸ ì‹¤íŒ¨:", err);
    }
  };

    // ì•Œë¦¼ ìˆ˜ì‹  í•¸ë“¤ëŸ¬
  onMessage(messaging, (payload) => {
    console.log("ğŸ“© ë©”ì‹œì§€ ë„ì°©:", payload);
    triggerClientNotification("ğŸ“¬ FCM ì•Œë¦¼ ë„ì°©", payload.notification.body);
  });
  
</script>
<script>
  
  // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì•Œë¦¼ íŠ¸ë¦¬ê±°
  document.addEventListener('DOMContentLoaded', () => {
    const testBtn = document.getElementById('testNotifyBtn');
    if (testBtn) {
      testBtn.addEventListener('click', () => {
        triggerClientNotification("ğŸ“© í…ŒìŠ¤íŠ¸ ì•Œë¦¼", "ì§€ê¸ˆ ì–´ë””ê¹Œì§€ í•˜ì…¨ë‚˜ìš”?");
      });
    }
  });

</script>
<script>
  let deposit = 0;
  let submittedDrafts = [];
  
  async function evaluateDraftProgress(prev, current) {
    const mode = "local"; // ë‚˜ì¤‘ì— "ai"ë¡œ ë°”ê¾¸ë©´ AI íŒë‹¨
    if (mode === "local") return localProgressJudge(prev, current);
    else return await aiProgressJudge(prev, current);
  }
  
  function localProgressJudge(prev, current) {
    const ratio = calculateDifferenceRatio(prev, current);
    return ratio < 0.1 ? "ì§„ì²™ë„ ì—†ìŒ" : "ì§„ì²™ë„ ìˆìŒ";
  }
  
  function calculateDifferenceRatio(oldText, newText) {
    const oldWords = oldText.split(/\s+/);
    const newWords = newText.split(/\s+/);
    let common = 0;
    newWords.forEach(word => { if (oldWords.includes(word)) common++; });
    return 1 - (common / newWords.length);
  }
  
  async function aiProgressJudge(prev, current) {
    const apiKey = "YOUR_OPENAI_API_KEY";
    const payload = {
      model: "gpt-4",
      messages: [
        { role: "system", content: "ë‘ ì‘ì—…ë¬¼ì„ ë¹„êµí•´ì„œ ì§„ì²™ë„ê°€ ìˆëŠ”ì§€ íŒë‹¨í•´ì¤˜." },
        { role: "user", content: `ì´ì „ ì‘ì—…ë¬¼:\n${prev}\n\ní˜„ì¬ ì‘ì—…ë¬¼:\n${current}` }
      ],
      temperature: 0.2
    };
  
    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      const result = data.choices[0].message.content;
  
      if (result.includes("ì§„ì²™ë„ ì—†ìŒ")) return "ì§„ì²™ë„ ì—†ìŒ";
      else return "ì§„ì²™ë„ ìˆìŒ";
    } catch (e) {
      console.error("AI íŒë‹¨ ì‹¤íŒ¨:", e);
      return "íŒë‹¨ ì‹¤íŒ¨";
    }
  }
  </script>  
  <script>
    // flatpickr ì´ˆê¸°í™”
    function initDatePicker(selector) {
  flatpickr(selector, {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    minDate: "today",
    time_24hr: false
  });
}
initDatePicker("#goalDateTime");
function getDraftDeadline() {
  return draftDeadlineObj;
}
  </script>
</body>
</html>
